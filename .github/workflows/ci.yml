# EcoTrack CI Pipeline
# Diese Pipeline fÃ¼hrt Tests nur fÃ¼r existierende Komponenten aus.
# Bei Pull Requests mÃ¼ssen alle relevanten Tests bestehen, bevor ein Merge mÃ¶glich ist.

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

# Parallele Jobs abbrechen bei neuen Commits
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Detect which components exist and changed
  # ============================================
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend-exists: ${{ steps.check.outputs.backend-exists }}
      admin-web-exists: ${{ steps.check.outputs.admin-web-exists }}
      mobile-exists: ${{ steps.check.outputs.mobile-exists }}
      backend-changed: ${{ steps.changes.outputs.backend }}
      admin-web-changed: ${{ steps.changes.outputs.admin-web }}
      mobile-changed: ${{ steps.changes.outputs.mobile }}
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check which components exist
        id: check
        run: |
          # Check if directories exist AND have relevant files
          if [ -d "server" ] && [ -f "server/pom.xml" ]; then
            echo "backend-exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Backend exists (server/pom.xml found)"
          else
            echo "backend-exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Backend not found (skipping)"
          fi
          
          if [ -d "admin-web" ] && [ -f "admin-web/package.json" ]; then
            echo "admin-web-exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Admin-Web exists (admin-web/package.json found)"
          else
            echo "admin-web-exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Admin-Web not found (skipping)"
          fi
          
          if [ -d "mobile" ] && [ -f "mobile/package.json" ]; then
            echo "mobile-exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Mobile exists (mobile/package.json found)"
          else
            echo "mobile-exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Mobile not found (skipping)"
          fi

      - name: Detect file changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'server/**'
            admin-web:
              - 'admin-web/**'
            mobile:
              - 'mobile/**'
            shared:
              - 'shared-resources/**'

      - name: Summary
        run: |
          echo "## ðŸ” Component Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Exists | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.check.outputs.backend-exists == 'true' && 'âœ…' || 'âŒ' }} | ${{ steps.changes.outputs.backend == 'true' && 'âœ…' || 'âž–' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin-Web | ${{ steps.check.outputs.admin-web-exists == 'true' && 'âœ…' || 'âŒ' }} | ${{ steps.changes.outputs.admin-web == 'true' && 'âœ…' || 'âž–' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mobile | ${{ steps.check.outputs.mobile-exists == 'true' && 'âœ…' || 'âŒ' }} | ${{ steps.changes.outputs.mobile == 'true' && 'âœ…' || 'âž–' }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Backend (Java/Spring Boot) Tests
  # Only runs if server/ exists
  # ============================================
  backend-build:
    name: ðŸ”¨ Backend Build
    runs-on: ubuntu-latest
    needs: detect-changes
    # Only run if backend exists
    if: needs.detect-changes.outputs.backend-exists == 'true'

    defaults:
      run:
        working-directory: ./server

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Compile Backend
        run: ./mvnw -B clean compile -DskipTests

  # ============================================
  # Admin-Web (React/TypeScript) Tests
  # Only runs if admin-web/ exists
  # ============================================
  admin-web-build:
    name: ðŸ”¨ Admin-Web Build
    runs-on: ubuntu-latest
    needs: detect-changes
    # Only run if admin-web exists
    if: needs.detect-changes.outputs.admin-web-exists == 'true'

    defaults:
      run:
        working-directory: ./admin-web

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: admin-web/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Type Check
        run: npm run type-check || npx tsc --noEmit

      - name: Build Application
        run: npm run build

  # ============================================
  # Mobile (React Native) Tests
  # Only runs if mobile/ exists
  # ============================================
  mobile-build:
    name: ðŸ”¨ Mobile Build
    runs-on: ubuntu-latest
    needs: detect-changes
    # Only run if mobile exists
    if: needs.detect-changes.outputs.mobile-exists == 'true'

    defaults:
      run:
        working-directory: ./mobile

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Type Check
        run: npm run type-check || npx tsc --noEmit

  # ============================================
  # OpenAPI Validation
  # ============================================
  api-validation:
    name: ðŸ“ API Contract Validation
    runs-on: ubuntu-latest
    needs: detect-changes

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check if OpenAPI file exists
        id: check-openapi
        run: |
          if [ -f "shared-resources/api-contracts/openapi.yaml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ OpenAPI file not found, skipping validation"
          fi

      - name: Validate OpenAPI Specification
        if: steps.check-openapi.outputs.exists == 'true'
        uses: char0n/swagger-editor-validate@v1
        with:
          definition-file: shared-resources/api-contracts/openapi.yaml

  # ============================================
  # Security Scan
  # ============================================
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================
  # Final Status Check
  # Smart check that only fails if existing components fail
  # ============================================
  ci-status:
    name: âœ… CI Status
    runs-on: ubuntu-latest
    needs: [detect-changes, backend-build, admin-web-build, mobile-build, api-validation]
    if: always()
    
    steps:
      - name: Evaluate CI Status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Exists | Build |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          FAILED=false
          
          # Backend Check
          BACKEND_EXISTS="${{ needs.detect-changes.outputs.backend-exists }}"
          BACKEND_RESULT="${{ needs.backend-build.result }}"
          if [ "$BACKEND_EXISTS" == "true" ]; then
            if [ "$BACKEND_RESULT" == "failure" ]; then
              echo "| Backend | âœ… | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
              FAILED=true
            elif [ "$BACKEND_RESULT" == "success" ]; then
              echo "| Backend | âœ… | âœ… Compiles |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Backend | âœ… | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Backend | âŒ Not found | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Admin-Web Check
          ADMINWEB_EXISTS="${{ needs.detect-changes.outputs.admin-web-exists }}"
          ADMINWEB_RESULT="${{ needs.admin-web-build.result }}"
          if [ "$ADMINWEB_EXISTS" == "true" ]; then
            if [ "$ADMINWEB_RESULT" == "failure" ]; then
              echo "| Admin-Web | âœ… | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
              FAILED=true
            elif [ "$ADMINWEB_RESULT" == "success" ]; then
              echo "| Admin-Web | âœ… | âœ… Compiles |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Admin-Web | âœ… | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Admin-Web | âŒ Not found | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Mobile Check
          MOBILE_EXISTS="${{ needs.detect-changes.outputs.mobile-exists }}"
          MOBILE_RESULT="${{ needs.mobile-build.result }}"
          if [ "$MOBILE_EXISTS" == "true" ]; then
            if [ "$MOBILE_RESULT" == "failure" ]; then
              echo "| Mobile | âœ… | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
              FAILED=true
            elif [ "$MOBILE_RESULT" == "success" ]; then
              echo "| Mobile | âœ… | âœ… Compiles |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Mobile | âœ… | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Mobile | âŒ Not found | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # API Validation Check
          API_RESULT="${{ needs.api-validation.result }}"
          if [ "$API_RESULT" == "failure" ]; then
            echo "| API Validation | - | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          elif [ "$API_RESULT" == "success" ]; then
            echo "| API Validation | - | âœ… Valid |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| API Validation | - | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$FAILED" == "true" ]; then
            echo "### âŒ CI Failed" >> $GITHUB_STEP_SUMMARY
            echo "One or more components failed to compile." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### âœ… CI Passed" >> $GITHUB_STEP_SUMMARY
            echo "All existing components compile successfully." >> $GITHUB_STEP_SUMMARY
          fi
