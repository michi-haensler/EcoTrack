# Code Coverage Reporting
# Sammelt Coverage-Reports und erstellt eine Zusammenfassung

name: Coverage Report

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  coverage:
    name: üìä Coverage Report
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: ecotrack
          POSTGRES_PASSWORD: ecotrack
          POSTGRES_DB: ecotrack_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Backend Coverage
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Generate Backend Coverage
        working-directory: ./_server
        run: |
          ./mvnw -B clean verify jacoco:report
        env:
          SPRING_PROFILES_ACTIVE: test
        continue-on-error: true

      # Frontend Coverage
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Admin-Web Coverage
        working-directory: ./_admin-web
        run: |
          npm ci
          npm test -- --coverage --reporter=json
        continue-on-error: true

      - name: Generate Mobile Coverage
        working-directory: ./_mobile
        run: |
          npm ci
          npm test -- --coverage --json --outputFile=coverage/coverage-summary.json
        continue-on-error: true

      # Create Summary
      - name: Create Coverage Summary
        run: |
          echo "## üìä Code Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Line Coverage | Branch Coverage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------------|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Backend Coverage (Jacoco)
          if [ -f "_server/target/site/jacoco/jacoco.xml" ]; then
            BACKEND_LINE=$(grep -oP 'type="LINE".*?counter.*?covered="\K[^"]+' _server/target/site/jacoco/jacoco.xml | head -1 || echo "0")
            BACKEND_MISSED=$(grep -oP 'type="LINE".*?counter.*?missed="\K[^"]+' _server/target/site/jacoco/jacoco.xml | head -1 || echo "0")
            if [ "$BACKEND_LINE" != "0" ] || [ "$BACKEND_MISSED" != "0" ]; then
              BACKEND_TOTAL=$((BACKEND_LINE + BACKEND_MISSED))
              BACKEND_PCT=$((BACKEND_LINE * 100 / BACKEND_TOTAL))
              if [ $BACKEND_PCT -ge 80 ]; then
                STATUS="‚úÖ"
              elif [ $BACKEND_PCT -ge 60 ]; then
                STATUS="‚ö†Ô∏è"
              else
                STATUS="‚ùå"
              fi
              echo "| Backend | ${BACKEND_PCT}% | - | ${STATUS} |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Backend | N/A | N/A | ‚è∏Ô∏è |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Backend | N/A | N/A | ‚è∏Ô∏è |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Admin-Web Coverage
          if [ -f "_admin-web/coverage/coverage-summary.json" ]; then
            WEB_PCT=$(cat _admin-web/coverage/coverage-summary.json | jq -r '.total.lines.pct // 0' 2>/dev/null || echo "0")
            if [ "$WEB_PCT" != "0" ] && [ "$WEB_PCT" != "null" ]; then
              if (( $(echo "$WEB_PCT >= 80" | bc -l) )); then
                STATUS="‚úÖ"
              elif (( $(echo "$WEB_PCT >= 60" | bc -l) )); then
                STATUS="‚ö†Ô∏è"
              else
                STATUS="‚ùå"
              fi
              echo "| Admin-Web | ${WEB_PCT}% | - | ${STATUS} |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Admin-Web | N/A | N/A | ‚è∏Ô∏è |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Admin-Web | N/A | N/A | ‚è∏Ô∏è |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Mobile Coverage
          if [ -f "_mobile/coverage/coverage-summary.json" ]; then
            MOBILE_PCT=$(cat _mobile/coverage/coverage-summary.json | jq -r '.total.lines.pct // 0' 2>/dev/null || echo "0")
            if [ "$MOBILE_PCT" != "0" ] && [ "$MOBILE_PCT" != "null" ]; then
              if (( $(echo "$MOBILE_PCT >= 80" | bc -l) )); then
                STATUS="‚úÖ"
              elif (( $(echo "$MOBILE_PCT >= 60" | bc -l) )); then
                STATUS="‚ö†Ô∏è"
              else
                STATUS="‚ùå"
              fi
              echo "| Mobile | ${MOBILE_PCT}% | - | ${STATUS} |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Mobile | N/A | N/A | ‚è∏Ô∏è |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Mobile | N/A | N/A | ‚è∏Ô∏è |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Legend" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ >= 80% (Target reached)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ö†Ô∏è >= 60% (Needs improvement)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå < 60% (Below target)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚è∏Ô∏è No tests found" >> $GITHUB_STEP_SUMMARY

      # Upload Coverage Artifacts
      - name: Upload Backend Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage-report
          path: _server/target/site/jacoco/
          retention-days: 14

      - name: Upload Admin-Web Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: admin-web-coverage-report
          path: _admin-web/coverage/
          retention-days: 14

      - name: Upload Mobile Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mobile-coverage-report
          path: _mobile/coverage/
          retention-days: 14

      # Comment on PR
      - name: Add Coverage Comment to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## üìä Coverage Report\n\n';
            comment += '| Component | Status |\n';
            comment += '|-----------|--------|\n';
            
            // Check which coverage reports exist
            const backendExists = fs.existsSync('_server/target/site/jacoco/jacoco.xml');
            const webExists = fs.existsSync('_admin-web/coverage/coverage-summary.json');
            const mobileExists = fs.existsSync('_mobile/coverage/coverage-summary.json');
            
            comment += `| Backend | ${backendExists ? '‚úÖ Generated' : '‚è∏Ô∏è Skipped'} |\n`;
            comment += `| Admin-Web | ${webExists ? '‚úÖ Generated' : '‚è∏Ô∏è Skipped'} |\n`;
            comment += `| Mobile | ${mobileExists ? '‚úÖ Generated' : '‚è∏Ô∏è Skipped'} |\n`;
            
            comment += '\n> Check the workflow summary for detailed coverage percentages.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
