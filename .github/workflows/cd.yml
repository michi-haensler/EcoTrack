# EcoTrack CD Pipeline
# Continuous Deployment Pipeline fÃ¼r den main Branch.
# Wird nur ausgefÃ¼hrt, wenn CI erfolgreich ist.

name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# Nur ein Deployment gleichzeitig
concurrency:
  group: deployment-${{ github.ref }}
  cancel-in-progress: false

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # CI Pipeline muss erfolgreich sein
  # ============================================
  ci:
    name: ðŸ”„ Run CI Pipeline
    uses: ./.github/workflows/ci.yml

  # ============================================
  # Build Docker Images
  # ============================================
  build-images:
    name: ðŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: ci
    permissions:
      contents: read
      packages: write

    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      admin-web-image: ${{ steps.meta-admin-web.outputs.tags }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Backend Image
      - name: Extract Backend metadata
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Admin-Web Image
      - name: Extract Admin-Web metadata
        id: meta-admin-web
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/admin-web
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Admin-Web image
        uses: docker/build-push-action@v5
        with:
          context: ./admin-web
          file: ./admin-web/Dockerfile
          push: true
          tags: ${{ steps.meta-admin-web.outputs.tags }}
          labels: ${{ steps.meta-admin-web.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Deploy to Staging
  # ============================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-images
    environment:
      name: staging
      url: https://staging.ecotrack.example.com
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy to Staging
        run: |
          echo "ðŸš€ Deploying to Staging environment..."
          echo "Backend Image: ${{ needs.build-images.outputs.backend-image }}"
          echo "Admin-Web Image: ${{ needs.build-images.outputs.admin-web-image }}"
          # Hier wÃ¼rde der eigentliche Deployment-Befehl stehen
          # z.B. kubectl apply, docker-compose pull && up, etc.

      - name: Run Smoke Tests
        run: |
          echo "ðŸ§ª Running smoke tests..."
          # curl -f https://staging.ecotrack.example.com/health || exit 1

      - name: Notify on Success
        run: |
          echo "âœ… Staging deployment successful!"

  # ============================================
  # Deploy to Production (Manual Approval)
  # ============================================
  deploy-production:
    name: ðŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-images, deploy-staging]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://ecotrack.example.com
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy to Production
        run: |
          echo "ðŸ­ Deploying to Production environment..."
          echo "Backend Image: ${{ needs.build-images.outputs.backend-image }}"
          echo "Admin-Web Image: ${{ needs.build-images.outputs.admin-web-image }}"
          # Hier wÃ¼rde der eigentliche Deployment-Befehl stehen

      - name: Run Health Checks
        run: |
          echo "ðŸ¥ Running health checks..."
          # curl -f https://ecotrack.example.com/health || exit 1

      - name: Create Release Tag
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const sha = context.sha.slice(0, 7);
            const tag = `v${date}-${sha}`;
            
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tag}`,
              sha: context.sha
            });
            
            console.log(`Created tag: ${tag}`);

      - name: Notify on Success
        run: |
          echo "âœ… Production deployment successful!"
          echo "## ðŸŽ‰ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
