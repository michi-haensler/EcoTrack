# EcoTrack Pull Request Checks
# ZusÃ¤tzliche Checks fÃ¼r Pull Requests

name: PR Checks

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, edited]

jobs:
  # ============================================
  # PR Title & Description Check
  # ============================================
  pr-validation:
    name: ðŸ“‹ PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Check PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            test
            chore
            perf
            ci
            build
            revert
          requireScope: false
          subjectPattern: ^[A-Z].*$
          subjectPatternError: |
            Der PR-Titel muss mit einem GroÃŸbuchstaben beginnen.
            Format: <type>: <Beschreibung>
            Beispiel: feat: Add user authentication

      - name: Check PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            if (body.length < 50) {
              core.setFailed('PR-Beschreibung muss mindestens 50 Zeichen lang sein.');
              return;
            }
            
            console.log('âœ… PR-Beschreibung ist ausreichend.');

  # ============================================
  # Changed Files Analysis
  # ============================================
  changed-files:
    name: ðŸ“ Analyze Changed Files
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      backend-exists: ${{ steps.check.outputs.backend-exists }}
      admin-web: ${{ steps.changes.outputs.admin-web }}
      admin-web-exists: ${{ steps.check.outputs.admin-web-exists }}
      mobile: ${{ steps.changes.outputs.mobile }}
      mobile-exists: ${{ steps.check.outputs.mobile-exists }}
      docs: ${{ steps.changes.outputs.docs }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Check which components exist
        id: check
        run: |
          if [ -d "_server" ] && [ -f "_server/pom.xml" ]; then
            echo "backend-exists=true" >> $GITHUB_OUTPUT
          else
            echo "backend-exists=false" >> $GITHUB_OUTPUT
          fi
          
          if [ -d "_admin-web" ] && [ -f "_admin-web/package.json" ]; then
            echo "admin-web-exists=true" >> $GITHUB_OUTPUT
          else
            echo "admin-web-exists=false" >> $GITHUB_OUTPUT
          fi
          
          if [ -d "_mobile" ] && [ -f "_mobile/package.json" ]; then
            echo "mobile-exists=true" >> $GITHUB_OUTPUT
          else
            echo "mobile-exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect Changed Files
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - '_server/**'
              - 'pom.xml'
            admin-web:
              - '_admin-web/**'
            mobile:
              - '_mobile/**'
            docs:
              - 'docs/**'
              - '*.md'
              - 'shared-resources/**'

      - name: Report Changes
        run: |
          echo "## ðŸ“ Changed Components" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.changes.outputs.backend == 'true' && 'âœ… Yes' || 'â¬œ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin-Web | ${{ steps.changes.outputs.admin-web == 'true' && 'âœ… Yes' || 'â¬œ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mobile | ${{ steps.changes.outputs.mobile == 'true' && 'âœ… Yes' || 'â¬œ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ steps.changes.outputs.docs == 'true' && 'âœ… Yes' || 'â¬œ No' }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Conditional Backend Tests
  # Only runs if backend exists AND files changed
  # ============================================
  backend-tests:
    name: ðŸ§ª Backend Tests (Conditional)
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.backend == 'true' && needs.changed-files.outputs.backend-exists == 'true'
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: ecotrack
          POSTGRES_PASSWORD: ecotrack
          POSTGRES_DB: ecotrack_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    defaults:
      run:
        working-directory: ./_server

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Tests
        run: ./mvnw -B clean verify
        env:
          SPRING_PROFILES_ACTIVE: test

  # ============================================
  # Conditional Admin-Web Tests
  # Only runs if admin-web exists AND files changed
  # ============================================
  admin-web-tests:
    name: ðŸ§ª Admin-Web Tests (Conditional)
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.admin-web == 'true' && needs.changed-files.outputs.admin-web-exists == 'true'

    defaults:
      run:
        working-directory: ./_admin-web

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: _admin-web/package-lock.json

      - name: Install & Test
        run: |
          npm ci
          npm run lint
          npm test

  # ============================================
  # Conditional Mobile Tests
  # Only runs if mobile exists AND files changed
  # ============================================
  mobile-tests:
    name: ðŸ§ª Mobile Tests (Conditional)
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.mobile == 'true' && needs.changed-files.outputs.mobile-exists == 'true'

    defaults:
      run:
        working-directory: ./_mobile

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: _mobile/package-lock.json

      - name: Install & Test
        run: |
          npm ci
          npm run lint
          npm test

  # ============================================
  # PR Status Summary
  # ============================================
  pr-status:
    name: âœ… PR Status
    runs-on: ubuntu-latest
    needs: [pr-validation, changed-files, backend-tests, admin-web-tests, mobile-tests]
    if: always()
    
    steps:
      - name: Check Status
        run: |
          echo "## ðŸ“Š PR Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          FAILED=false
          
          if [[ "${{ needs.pr-validation.result }}" == "failure" ]]; then
            echo "âŒ PR Validation failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          if [[ "${{ needs.backend-tests.result }}" == "failure" ]]; then
            echo "âŒ Backend Tests failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          if [[ "${{ needs.admin-web-tests.result }}" == "failure" ]]; then
            echo "âŒ Admin-Web Tests failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          if [[ "${{ needs.mobile-tests.result }}" == "failure" ]]; then
            echo "âŒ Mobile Tests failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
          
          if [[ "$FAILED" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**â›” Please fix the failing checks before merging.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "âœ… All PR checks passed!" >> $GITHUB_STEP_SUMMARY
